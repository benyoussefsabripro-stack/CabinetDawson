<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST DEBUG - Dawson</title>
    <style>
        body { background: #111; color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }
        .box { background: #222; padding: 40px; border: 2px solid #d4af37; border-radius: 10px; text-align: center; width: 300px;}
        input { display: block; width: 100%; padding: 10px; margin: 10px 0; border-radius: 5px; border: none; }
        button { background: #d4af37; color: black; font-weight: bold; border: none; padding: 15px; width: 100%; cursor: pointer; }
        h1 { color: #d4af37; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="login-screen" class="box">
        <h1>TEST CONNEXION</h1>
        <p>Ouvre ce fichier, si aucune alerte ne s'affiche au démarrage, c'est que ton navigateur bloque le script.</p>
        <input type="text" id="loginUser" placeholder="Nom Prénom (ex: James Dawson)">
        <input type="password" id="loginPass" placeholder="Mot de passe">
        <button id="btnLogin">TESTER LA CONNEXION</button>
        <p id="status" style="color: yellow; margin-top: 20px;">En attente...</p>
    </div>

    <div id="success-screen" class="box hidden">
        <h1 style="color: green;">ÇA MARCHE !</h1>
        <p>Bienvenue <span id="userName"></span></p>
        <p>Rôle : <span id="userRole"></span></p>
        <p>Tu peux maintenant remettre le code complet !</p>
    </div>

    <script type="module">
        // 1. IMPORTATION
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Alerte de démarrage
        alert("ETAPE 1 : Le script JavaScript démarre bien.");

       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAFJWLubNJiWIys9yHmtY--9QtDZ4hsbY0",
  authDomain: "dawson-cabinet.firebaseapp.com",
  projectId: "dawson-cabinet",
  storageBucket: "dawson-cabinet.firebasestorage.app",
  messagingSenderId: "660518713250",
  appId: "1:660518713250:web:a00a8c615d08868ab264fb",
  measurementId: "G-QJPKCGYCBT"
};

        let db;

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            alert("ETAPE 2 : Firebase semble configuré (Techniquement). On va tester la base de données.");
            document.getElementById('status').innerText = "Firebase initialisé...";
        } catch (e) {
            alert("ERREUR ETAPE 2 : Problème de configuration Firebase.\n" + e.message);
        }

        // Action bouton
        document.getElementById('btnLogin').addEventListener('click', async () => {
            alert("ETAPE 3 : Bouton cliqué. Recherche en cours...");
            
            const u = document.getElementById('loginUser').value.trim();
            const p = document.getElementById('loginPass').value.trim();

            if(!u || !p) {
                alert("Remplis les champs stp !");
                return;
            }

            document.getElementById('status').innerText = "Recherche dans la base de données...";

            try {
                // On va chercher TOUS les utilisateurs pour voir ce qu'il y a
                const q = collection(db, "users");
                const querySnapshot = await getDocs(q);
                
                let found = false;
                let userDetails = null;
                let totalUsers = 0;

                querySnapshot.forEach((doc) => {
                    totalUsers++;
                    const data = doc.data();
                    // Comparaison simple
                    if (data.name.toLowerCase() === u.toLowerCase() && data.pass === p) {
                        found = true;
                        userDetails = data;
                    }
                });

                if (totalUsers === 0) {
                    alert("ERREUR CRITIQUE : La base de données est VIDE !\nTu n'as pas créé le compte 'James Dawson' dans Firestore (onglet Données).");
                } else if (found) {
                    alert("SUCCÈS : Utilisateur trouvé !");
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('success-screen').classList.remove('hidden');
                    document.getElementById('userName').innerText = userDetails.name;
                    document.getElementById('userRole').innerText = userDetails.role;
                } else {
                    alert("ECHEC : Identifiants incorrects.\n\nIl y a " + totalUsers + " utilisateurs dans la base, mais aucun ne correspond à : " + u + " / " + p);
                }

            } catch (error) {
                alert("ERREUR ETAPE 4 : Impossible de lire la base de données.\n\n" + error.message + "\n\n Vérifie que ta base est bien en mode TEST (Règles de sécurité).");
                console.error(error);
            }
        });
    </script>
</body>
</html>
