<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MODE DIAGNOSTIC - Dawson</title>
    <style>
        body { background: #121212; color: white; font-family: monospace; padding: 20px; }
        h1 { color: #d4af37; text-align: center; }
        .box { max-width: 600px; margin: 0 auto; background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; }
        
        /* Console de débogage visuelle */
        #debug-console { 
            background: #000; border: 2px solid #555; padding: 15px; 
            margin-top: 20px; min-height: 200px; white-space: pre-wrap; font-size: 13px;
        }
        .log { color: #0f0; } /* Vert */
        .warn { color: orange; } /* Orange */
        .error { color: #ff4d4d; font-weight: bold; border-left: 4px solid red; padding-left: 10px; } /* Rouge */

        input { width: 100%; padding: 10px; margin: 5px 0; background: #333; border: 1px solid #555; color: white; }
        button { width: 100%; padding: 15px; background: #d4af37; border: none; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>MODE DIAGNOSTIC</h1>
    
    <div class="box">
        <h3>Test de Connexion</h3>
        <input type="text" id="testUser" placeholder="Identifiant (ex: paul mariani)">
        <input type="password" id="testPass" placeholder="Mot de passe">
        <button id="btnTest">TESTER LA CONNEXION</button>
    </div>

    <div id="debug-console">Initialisation du système de diagnostic...<br></div>

    <script type="module">
        // Fonction pour écrire dans la console visuelle
        function log(msg, type = 'log') {
            const el = document.getElementById('debug-console');
            el.innerHTML += `<div class="${type}">> ${msg}</div>`;
        }

        // 1. Capturer les erreurs de syntaxe globales
        window.onerror = function(message, source, lineno, colno, error) {
            log(`ERREUR CRITIQUE (Syntaxe) :\n${message}\nLigne: ${lineno}`, 'error');
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        try {
            log("Modules Firebase importés avec succès.");

           // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAFJWLubNJiWIys9yHmtY--9QtDZ4hsbY0",
  authDomain: "dawson-cabinet.firebaseapp.com",
  projectId: "dawson-cabinet",
  storageBucket: "dawson-cabinet.firebasestorage.app",
  messagingSenderId: "660518713250",
  appId: "1:660518713250:web:a00a8c615d08868ab264fb",
  measurementId: "G-QJPKCGYCBT"
};

            log("Configuration chargée. Connexion à Google...");
            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);
            log("Firebase initialisé. Vérification de la base de données...");

            // Test automatique : Lire la liste des utilisateurs
            getDocs(collection(db, "users"))
                .then((snapshot) => {
                    if (snapshot.empty) {
                        log("⚠️ ATTENTION : Connexion réussie mais la collection 'users' est VIDE !", 'warn');
                        log("Conseil : Va sur Firebase > Firestore > Données et crée la collection 'users' avec un premier compte.", 'warn');
                    } else {
                        log(`✅ SUCCÈS : ${snapshot.size} utilisateurs trouvés dans la base.`, 'log');
                        let usersList = [];
                        snapshot.forEach(doc => {
                            const u = doc.data();
                            log(`   - Trouvé : "${u.name}" (Pass: "${u.pass}")`);
                            usersList.push(u);
                        });

                        // Activer le bouton de test
                        document.getElementById('btnTest').addEventListener('click', () => {
                            const inputU = document.getElementById('testUser').value.trim();
                            const inputP = document.getElementById('testPass').value.trim();
                            
                            log(`Tentative de connexion avec : "${inputU}" / "${inputP}"...`);
                            
                            const found = usersList.find(user => user.name.toLowerCase() === inputU.toLowerCase() && user.pass === inputP);
                            
                            if (found) {
                                log(`✅ VALIDÉ ! Connexion réussie pour ${found.name}.`, 'log');
                                log("CONCLUSION : Ton code marche. Remets le code original en faisant attention aux clés.", 'log');
                            } else {
                                log(`❌ ÉCHEC : Aucun utilisateur ne correspond. Vérifie l'orthographe exacte dans la liste ci-dessus.`, 'error');
                            }
                        });
                    }
                })
                .catch((error) => {
                    log(`ERREUR BASE DE DONNÉES :\n${error.message}`, 'error');
                    if(error.message.includes("permission-denied")) {
                        log("CAUSE PROBABLE : Tes règles de sécurité bloquent l'accès. Mets ta base en mode TEST.", 'warn');
                    }
                });

        } catch (e) {
            log(`ERREUR CONFIGURATION :\n${e.message}`, 'error');
            log("Vérifie que tu as bien copié les clés sans oublier de virgule ou de guillemet.", 'warn');
        }
    </script>

</body>
</html>
