<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Intranet Dawson & Partners (Cloud)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        
        /* RESET & FONTS */
:root { 
    --bg-dark: #0f0f13; 
    --panel-bg: rgba(30, 30, 35, 0.95); 
    --gold: #d4af37; 
    --text-main: #fff; 
    --font-main: 'Segoe UI', system-ui, sans-serif; 
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

body { 
    background: radial-gradient(circle at top right, #1a1a20 0%, #0f0f13 100%); 
    color: var(--text-main); 
    font-family: var(--font-main); 
    min-height: 100vh; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    overflow-x: hidden; 
}

.hidden { display: none !important; }
.fade-in { animation: fadeIn 0.5s ease forwards; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* PANNEAUX & STYLE */
.glass-panel { 
    background: var(--panel-bg); 
    backdrop-filter: blur(12px); 
    border: 1px solid rgba(255,255,255,0.08); 
    border-radius: 16px; 
    box-shadow: 0 8px 32px rgba(0,0,0,0.4); 
}

/* LOGIN */
#login-screen { width: 90%; max-width: 420px; padding: 40px; text-align: center; border-top: 4px solid var(--gold); }

/* INPUTS */
.input-group { margin-bottom: 15px; text-align: left; }
label { display: block; color: #a0a0a0; font-size: 0.75rem; margin-bottom: 6px; text-transform: uppercase; font-weight: 600; }
input, select { 
    width: 100%; padding: 12px; 
    background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); 
    border-radius: 8px; color: #fff; font-size: 1rem; 
}

/* BOUTONS */
.btn-primary { 
    width: 100%; padding: 14px; 
    background: linear-gradient(135deg, var(--gold), #b38f26); 
    color: #000; font-weight: bold; border: none; 
    border-radius: 8px; cursor: pointer; text-transform: uppercase; margin-top: 10px; 
}
.btn-primary:hover { transform: translateY(-2px); }

.btn-pdf { 
    background: #fff; color: #000; padding: 8px 15px; 
    border-radius: 6px; cursor: pointer; font-weight: bold; border: none; 
}

/* LAYOUT APP */
#app-screen { width: 100%; max-width: 1400px; padding: 20px; }
.navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 25px; margin-bottom: 25px; }

.admin-section { padding: 25px; margin-bottom: 25px; border: 1px solid var(--gold); background: rgba(212, 175, 55, 0.05); }

/* STATS GRID */
.stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
.stat-card { padding: 20px; text-align: center; border-bottom: 3px solid transparent; }
.stat-card.highlight-gold { border-bottom-color: var(--gold); }
.money { font-family: monospace; font-size: 1.5rem; color: var(--gold); margin-top: 5px; }

/* FORM GRID */
.form-grid { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 15px; align-items: end; }

/* TABLEAU */
.table-responsive { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; min-width: 800px; }
th { text-align: left; padding: 15px; color: #a0a0a0; font-size: 0.7rem; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); }
td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }

/* MOBILE */
@media (max-width: 900px) { 
    .form-grid { grid-template-columns: 1fr; } 
    .navbar { flex-direction: column; align-items: flex-start; gap: 10px; } 
}

    </style>
</head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<div id="login-screen" class="glass-panel fade-in">
    <h2 style="color:#d4af37; margin-bottom:5px;">DAWSON & PARTNERS</h2>
    <p style="color:#888; margin-bottom:30px;">Intranet Cloud</p>
    
    <div class="input-group">
        <label>Nom de famille</label>
        <input type="text" id="loginUser" placeholder="Ex: James Dawson">
    </div>
    <div class="input-group">
        <label>Mot de passe</label>
        <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    
    <button class="btn-primary" id="btnLogin">Connexion</button>
    <p id="loginError" class="hidden" style="color:#ff4d4d; margin-top:10px;">‚õî Acc√®s refus√©</p>
</div>

<div id="app-screen" class="hidden">
    <nav class="navbar glass-panel">
        <div>
            <h1 style="color:#d4af37; font-size:1.2rem; margin:0;">DAWSON & PARTNERS</h1>
            <span id="roleBadge" style="font-size:0.8rem; color:#fff; font-weight:bold;">...</span>
        </div>
        <button id="btnLogout" style="background:none; border:1px solid #444; color:#fff; padding:8px 12px; border-radius:4px; cursor:pointer;">D√©connexion</button>
    </nav>

    <div id="adminPanel" class="admin-section glass-panel hidden">
        <h3 style="color:#d4af37; margin-bottom:15px;">üëë Gestion RH (Admin)</h3>
        <div class="form-grid">
            <div class="input-group"><label>Nom Complet</label><input type="text" id="newUserName"></div>
            <div class="input-group"><label>Mot de passe</label><input type="text" id="newUserPass"></div>
            <div class="input-group"><label>Grade</label>
                <select id="newUserGrade">
                    <option value="0.75">Pr√©sident (75%)</option>
                    <option value="0.65">Partenaire Directeur (65%)</option>
                    <option value="0.60">Partenaire S√©nior (60%)</option>
                    <option value="0.55">Partenaire (55%)</option>
                    <option value="0.50">Partenaire Junior (50%)</option>
                    <option value="0.40">Avocat S√©nior (40%)</option>
                    <option value="0.35" selected>Avocat (35%)</option>
                    <option value="0.30">Avocat Junior (30%)</option>
                    <option value="0">Parajuriste (0%)</option>
                    <option value="0">Assistant Juridique (0%)</option>
                </select>
            </div>
            <button class="btn-primary" id="btnCreateUser">Cr√©er Compte</button>
        </div>
    </div>

    <div class="stats-row">
        <div class="stat-card glass-panel">
            <span>Total Cabinet</span>
            <h3 id="totalEtat" class="money">0 $</h3>
        </div>
        <div class="stat-card glass-panel highlight-gold">
            <span>Vos Commissions</span>
            <h3 id="totalGain" class="money" style="color:#00e676">0 $</h3>
        </div>
        <div class="stat-card glass-panel">
            <span>Amendes</span>
            <h3 id="totalAmendes" class="money">0 $</h3>
        </div>
    </div>

    <div class="glass-panel" style="padding:25px; margin-bottom:25px;">
        <h3 style="color:#d4af37; margin-bottom:20px;">Nouveau Dossier Commis (+150k)</h3>
        <div class="form-grid">
            <div class="input-group"><label>Client</label><input type="text" id="client"></div>
            <div class="input-group"><label>Charges</label><input type="text" id="charges"></div>
            <div class="input-group"><label>Amende ($)</label><input type="number" id="amende"></div>
            
            <div style="display:flex; gap:15px; align-items:center;">
                <label style="color:#fff; cursor:pointer;"><input type="checkbox" id="proces"> Proc√®s</label>
                <label style="color:#fff; cursor:pointer;"><input type="checkbox" id="accord"> Accord</label>
            </div>
            
            <button class="btn-primary" id="btnAddCase" style="grid-column:1/-1">Enregistrer le Dossier</button>
        </div>
    </div>

    <div class="glass-panel" style="padding:0;">
        <div style="padding:20px; display:flex; justify-content:space-between; align-items:center;">
            <h3>Historique</h3>
            <button class="btn-pdf" onclick="exporterPDF()">üìÑ T√©l√©charger PDF</button>
        </div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Avocat</th>
                        <th>Client</th>
                        <th>Charges</th>
                        <th>Amende</th>
                        <th>Proc√®s</th>
                        <th>Accord</th>
                        <th>Com</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="listeDossiers"></tbody>
            </table>
        </div>
    </div>
</div>
<body>

    <script type="module">

     // IMPORTATION DES MODULES FIREBASE (OBLIGATOIRE POUR LE CLOUD)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAFJWLubNJiWIys9yHmtY--9QtDZ4hsbY0",
  authDomain: "dawson-cabinet.firebaseapp.com",
  projectId: "dawson-cabinet",
  storageBucket: "dawson-cabinet.firebasestorage.app",
  messagingSenderId: "660518713250",
  appId: "1:660518713250:web:a00a8c615d08868ab264fb",
  measurementId: "G-QJPKCGYCBT"
};

// INITIALISATION
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const PRIX_COMMIS = 150000;

let currentUser = null;
let globalUsers = [];
let globalDossiers = [];

// 1. √âCOUTE EN TEMPS R√âEL : UTILISATEURS
onSnapshot(collection(db, "users"), (snap) => {
    globalUsers = [];
    snap.forEach(d => globalUsers.push({id: d.id, ...d.data()}));
});

// 2. √âCOUTE EN TEMPS R√âEL : DOSSIERS
onSnapshot(query(collection(db, "dossiers")), (snap) => {
    globalDossiers = [];
    snap.forEach(d => globalDossiers.push({id: d.id, ...d.data()}));
    // Si connect√©, mettre √† jour le tableau en direct
    if(currentUser) renderTable();
});

// --- GESTION DE LA CONNEXION ---
document.getElementById('btnLogin').addEventListener('click', () => {
    const u = document.getElementById('loginUser').value.trim();
    const p = document.getElementById('loginPass').value.trim();
    
    // V√©rification dans la liste charg√©e depuis le Cloud
    const found = globalUsers.find(user => user.name.toLowerCase() === u.toLowerCase() && user.pass === p);
    
    if(found) {
        currentUser = found;
        lancerApplication();
    } else {
        document.getElementById('loginError').classList.remove('hidden');
    }
});

document.getElementById('btnLogout').addEventListener('click', () => {
    location.reload(); // Recharge la page pour d√©connecter
});

function lancerApplication() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app-screen').classList.remove('hidden');
    
    // Mettre √† jour les infos du haut
    document.getElementById('roleBadge').innerText = currentUser.role;

    // Afficher panneau admin si c'est Dawson ou Mariani
    const nom = currentUser.name.toLowerCase();
    if(nom.includes('dawson') || nom.includes('mariani')) {
        document.getElementById('adminPanel').classList.remove('hidden');
    }
    
    renderTable();
}

// --- AJOUTER UN DOSSIER ---
document.getElementById('btnAddCase').addEventListener('click', async () => {
    const client = document.getElementById('client').value;
    if(!client) return alert("Nom du client obligatoire !");

    const charges = document.getElementById('charges').value;
    const amende = parseFloat(document.getElementById('amende').value) || 0;
    const proces = document.getElementById('proces').checked;
    const accord = document.getElementById('accord').checked;
    
    const gain = PRIX_COMMIS * currentUser.grade;

    // ENVOI VERS FIREBASE (CLOUD)
    try {
        await addDoc(collection(db, "dossiers"), {
            timestamp: Date.now(),
            auteur: currentUser.name,
            client: client,
            charges: charges,
            amende: amende,
            proces: proces,
            accord: accord,
            factureEtat: PRIX_COMMIS,
            gainAvocat: gain
        });

        // Vider les champs
        document.getElementById('client').value = "";
        document.getElementById('charges').value = "";
        document.getElementById('amende').value = "";
        document.getElementById('proces').checked = false;
        document.getElementById('accord').checked = false;
        
    } catch(e) {
        alert("Erreur d'envoi : " + e.message);
    }
});

// --- AFFICHAGE DU TABLEAU ---
function renderTable() {
    const tbody = document.getElementById('listeDossiers');
    tbody.innerHTML = "";
    
    let totalEtat = 0;
    let totalGain = 0;
    let totalAmendes = 0;
    
    // Tri par date (plus r√©cent en haut)
    const listeTriee = [...globalDossiers].sort((a,b) => b.timestamp - a.timestamp);

    listeTriee.forEach(d => {
        totalEtat += d.factureEtat;
        totalAmendes += d.amende;
        if(d.auteur === currentUser.name) totalGain += d.gainAvocat;

        const isMe = d.auteur === currentUser.name;
        const isAdmin = currentUser.name.toLowerCase().includes('dawson') || currentUser.name.toLowerCase().includes('mariani');
        
        // Bouton supprimer visible seulement si c'est moi ou le patron
        const delBtn = (isMe || isAdmin) ? 
            `<button onclick="window.suppr('${d.id}')" style="color:#ff4d4d; border:none; background:none; cursor:pointer; font-size:1.2rem;">√ó</button>` : '';
        
        const styleMoi = isMe ? 'color:#fff; font-weight:bold;' : 'color:#888;';

        const row = `
            <tr>
                <td style="${styleMoi}">${d.auteur}</td>
                <td style="color:#d4af37; font-weight:600;">${d.client}</td>
                <td style="color:#aaa; font-size:0.9rem;">${d.charges}</td>
                <td style="font-family:monospace;">${d.amende} $</td>
                <td>${d.proces ? '‚úÖ' : '‚ùå'}</td>
                <td>${d.accord ? '‚úÖ' : '‚ùå'}</td>
                <td style="color:#00e676; font-weight:bold;">${isMe ? '+ '+d.gainAvocat+' $' : ''}</td>
                <td style="text-align:center;">${delBtn}</td>
            </tr>
        `;
        tbody.innerHTML += row;
    });

    // Mettre √† jour les totaux en haut
    document.getElementById('totalEtat').innerText = totalEtat.toLocaleString() + " $";
    document.getElementById('totalGain').innerText = totalGain.toLocaleString() + " $";
    document.getElementById('totalAmendes').innerText = totalAmendes.toLocaleString() + " $";
}

// --- FONCTION SUPPRESSION (CLOUD) ---
// On l'attache √† window pour qu'elle soit accessible depuis le HTML
window.suppr = async (id) => {
    if(confirm("Confirmer la suppression d√©finitive ?")) {
        await deleteDoc(doc(db, "dossiers", id));
    }
};

// --- CR√âATION UTILISATEUR (ADMIN) ---
document.getElementById('btnCreateUser').addEventListener('click', async () => {
    const name = document.getElementById('newUserName').value;
    const pass = document.getElementById('newUserPass').value;
    const grade = parseFloat(document.getElementById('newUserGrade').value);
    
    // R√©cup√©rer le texte du r√¥le (ex: "Avocat")
    const sel = document.getElementById('newUserGrade');
    const role = sel.options[sel.selectedIndex].text.split('(')[0].trim();

    if(!name || !pass) return alert("Remplissez tout !");

    await addDoc(collection(db, "users"), {
        name: name,
        pass: pass,
        grade: grade,
        role: role
    });
    
    alert("Utilisateur cr√©√© avec succ√®s !");
    document.getElementById('newUserName').value = "";
    document.getElementById('newUserPass').value = "";
});

// --- EXPORT PDF ---
window.exporterPDF = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    doc.text("RAPPORT CABINET DAWSON & PARTNERS", 14, 20);
    doc.setFontSize(10);
    doc.text("G√©n√©r√© par " + currentUser.name, 14, 26);
    
    const data = globalDossiers.map(d => [
        d.auteur, d.client, d.charges, d.amende + " $", d.gainAvocat + " $"
    ]);
    
    doc.autoTable({
        startY: 35,
        head: [['Avocat', 'Client', 'Charges', 'Amende', 'Com.']],
        body: data,
        theme: 'striped',
        headStyles: { fillColor: [212, 175, 55] }
    });
    
    doc.save("Rapport_Cabinet.pdf");
};


    </script>

</body>
</html>
